# Scorm tool API

Scorm tool API project is a simple API for working with SCORM files. Currently only files generated by Rise Articulate are supported.

## Technologies

The project is written in TypeScript, using Prisma as an ORM for database connectivity and management. Nodemon is used in development mode to monitor for file changes.

## Installation

Run `npm install` to install all dependencies, then either `npm start` to run in production mode, or `npm run dev` to start in development mode.

Development mode uses nodemon to monitor for file changes.

## Initial setup

Database connection string should be stored in an environment variable (can use `.env` file) called `DATABASE_URL` [read documentation](https://www.prisma.io/docs/getting-started/setup-prisma/start-from-scratch/relational-databases/connect-your-database-typescript-postgres).

Can use `npx prisma migrate dev` to [generate database and update using migration scripts](https://www.prisma.io/docs/reference/api-reference/command-reference#migrate-dev).

There is a seed script to create the admin user, run with `npx prisma db seed` or `npm run seed`.

The following environment variables are required for the API to work:

- DATABASE_URL
- AUTH0_AUDIENCE
- AUTH0_BASE_URL
- ADMIN_EMAIL
- ADMIN_NAME

## Usage

`DATABASE_URL` environment variable is required to work (see [Initial setup](#initial-setup) above)

Run with the included `Dockerfile`.

Build with:

```bash
docker build . -t scorm-tool-api
```

Run with

```bash
docker run -p 3001:3001 --name scorm-tool-api scorm-tool-api
```

It's an API, you make calls to the endpoints. No, there's currently no mapping of the endpoints, I'll add that to the TODO list...

## Notes

V2 includes token based authentication sent with requests.

## AUTH0

There are two auth variables that need to be defined

- AUTH0_AUDIENCE
- AUTH0_BASE_URL

`AUTH0_AUDIENCE` is the identifier given in the Auth0 settings page of the API
`AUTH0_BASE_URL` is the issuer base URL (easiest thing to do is look at the quickstart guide for Node.js; that's where I took the code from)

### Database Updates

1. Edit the schema in `prisma/schema.prisma` and save the file
2. Run `npx prisma migrate dev --name <some meaningful name>` to save and apply the migration

## Deployment with fly.io

3 secrets need to be set, `AUTH0_AUDIENCE`, `AUTH0_BASE_URL` and `DATABASE_URL`

```bash
flyctl secrets set AUTH0_AUDIENCE=<audience>
flyctl secrets set AUTH0_BASE_URL=<base url>
flyctl secrets set DATABASE_URL=<database url>
```

The database URL will need to use the internal hostname of the database, which can be found by running

```bash
flyctl status -a <app name>
```

On the database app, and using the app name .internal as the hostname (e.g. `scorm-tool-api-db.internal`)

1 GB volume will need expanding

```bash
flyctl vol extend
```

Can be proxied to connect up local UI to the API

```bash
flyctl proxy 3001 -a <app name>
```

### CD pipeline

There is a CD pipeline set up to deploy to fly.io on push to the `master` branch. This is set up in the `fly.toml`, and `.github/workflows/fly.yml` files.
